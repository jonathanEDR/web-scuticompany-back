/**
 * üîç Script de Verificaci√≥n de √çndices MongoDB - Blog Posts
 * 
 * Este script:
 * 1. Conecta a MongoDB
 * 2. Lista todos los √≠ndices del modelo BlogPost
 * 3. Analiza el uso y eficiencia de cada √≠ndice
 * 4. Recomienda optimizaciones si es necesario
 * 
 * Uso: node scripts/verify-blog-indexes.js
 */

import mongoose from 'mongoose';
import dotenv from 'dotenv';
import BlogPost from '../backend/models/BlogPost.js';

dotenv.config();

const MONGODB_URI = process.env.MONGODB_URI || 'mongodb://localhost:27017/web-scuti';

async function verifyBlogIndexes() {
  try {
    console.log('üîó Conectando a MongoDB...');
    await mongoose.connect(MONGODB_URI);
    console.log('‚úÖ Conectado a MongoDB\n');

    const collection = mongoose.connection.db.collection('blogposts');

    // 1. Listar √≠ndices existentes
    console.log('üìã √çNDICES EXISTENTES:');
    console.log('=' .repeat(80));
    
    const indexes = await collection.indexes();
    
    indexes.forEach((index, i) => {
      console.log(`\n${i + 1}. ${index.name || 'unnamed'}`);
      console.log(`   Keys: ${JSON.stringify(index.key)}`);
      if (index.unique) console.log(`   ‚≠ê √öNICO`);
      if (index.sparse) console.log(`   üìå SPARSE (solo docs con valor)`);
      if (index.weights) console.log(`   üîç TEXT INDEX (weights: ${JSON.stringify(index.weights)})`);
    });

    // 2. Estad√≠sticas de la colecci√≥n
    console.log('\n\nüìä ESTAD√çSTICAS DE COLECCI√ìN:');
    console.log('=' .repeat(80));
    
    const stats = await collection.stats();
    console.log(`Total de documentos: ${stats.count.toLocaleString()}`);
    console.log(`Tama√±o de datos: ${(stats.size / 1024 / 1024).toFixed(2)} MB`);
    console.log(`Tama√±o de √≠ndices: ${(stats.totalIndexSize / 1024 / 1024).toFixed(2)} MB`);
    console.log(`N√∫mero de √≠ndices: ${stats.nindexes}`);

    // 3. Ejemplos de queries y uso de √≠ndices
    console.log('\n\nüîç AN√ÅLISIS DE QUERIES FRECUENTES:');
    console.log('=' .repeat(80));

    // Query 1: Posts destacados
    console.log('\n1Ô∏è‚É£  Posts Destacados (Featured):');
    const featuredExplain = await BlogPost.find({
      isPublished: true,
      status: 'published',
      isFeatured: true
    })
      .sort({ publishedAt: -1 })
      .limit(5)
      .explain('executionStats');
    
    console.log(`   √çndice usado: ${featuredExplain.executionStats.executionStages.inputStage?.indexName || 'COLLECTION SCAN ‚ö†Ô∏è'}`);
    console.log(`   Docs examinados: ${featuredExplain.executionStats.totalDocsExamined}`);
    console.log(`   Docs retornados: ${featuredExplain.executionStats.nReturned}`);
    console.log(`   Tiempo: ${featuredExplain.executionStats.executionTimeMillis}ms`);
    console.log(`   Eficiencia: ${((featuredExplain.executionStats.nReturned / (featuredExplain.executionStats.totalDocsExamined || 1)) * 100).toFixed(2)}%`);

    // Query 2: Posts por categor√≠a
    console.log('\n2Ô∏è‚É£  Posts por Categor√≠a:');
    const categories = await mongoose.connection.db.collection('blogcategories').findOne();
    if (categories) {
      const categoryExplain = await BlogPost.find({
        category: categories._id,
        isPublished: true,
        status: 'published'
      })
        .sort({ publishedAt: -1 })
        .limit(10)
        .explain('executionStats');
      
      console.log(`   √çndice usado: ${categoryExplain.executionStats.executionStages.inputStage?.indexName || 'COLLECTION SCAN ‚ö†Ô∏è'}`);
      console.log(`   Docs examinados: ${categoryExplain.executionStats.totalDocsExamined}`);
      console.log(`   Docs retornados: ${categoryExplain.executionStats.nReturned}`);
      console.log(`   Tiempo: ${categoryExplain.executionStats.executionTimeMillis}ms`);
      console.log(`   Eficiencia: ${((categoryExplain.executionStats.nReturned / (categoryExplain.executionStats.totalDocsExamined || 1)) * 100).toFixed(2)}%`);
    }

    // Query 3: Posts recientes publicados
    console.log('\n3Ô∏è‚É£  Posts Recientes Publicados:');
    const recentExplain = await BlogPost.find({
      isPublished: true,
      status: 'published'
    })
      .sort({ publishedAt: -1 })
      .limit(10)
      .explain('executionStats');
    
    console.log(`   √çndice usado: ${recentExplain.executionStats.executionStages.inputStage?.indexName || 'COLLECTION SCAN ‚ö†Ô∏è'}`);
    console.log(`   Docs examinados: ${recentExplain.executionStats.totalDocsExamined}`);
    console.log(`   Docs retornados: ${recentExplain.executionStats.nReturned}`);
    console.log(`   Tiempo: ${recentExplain.executionStats.executionTimeMillis}ms`);
    console.log(`   Eficiencia: ${((recentExplain.executionStats.nReturned / (recentExplain.executionStats.totalDocsExamined || 1)) * 100).toFixed(2)}%`);

    // Query 4: B√∫squeda por slug
    console.log('\n4Ô∏è‚É£  B√∫squeda por Slug:');
    const firstPost = await BlogPost.findOne({});
    if (firstPost) {
      const slugExplain = await BlogPost.findOne({ slug: firstPost.slug })
        .explain('executionStats');
      
      console.log(`   √çndice usado: ${slugExplain.executionStats.executionStages.inputStage?.indexName || 'COLLECTION SCAN ‚ö†Ô∏è'}`);
      console.log(`   Docs examinados: ${slugExplain.executionStats.totalDocsExamined}`);
      console.log(`   Docs retornados: ${slugExplain.executionStats.nReturned}`);
      console.log(`   Tiempo: ${slugExplain.executionStats.executionTimeMillis}ms`);
      console.log(`   ‚ö° DEBE usar √≠ndice √∫nico 'slug_1'`);
    }

    // 4. Recomendaciones
    console.log('\n\nüí° RECOMENDACIONES:');
    console.log('=' .repeat(80));
    
    const postCount = await BlogPost.countDocuments();
    
    if (postCount < 100) {
      console.log('‚ö†Ô∏è  Colecci√≥n peque√±a (< 100 posts)');
      console.log('   ‚Üí Los √≠ndices tienen impacto m√≠nimo con pocos documentos');
      console.log('   ‚Üí Beneficio real se ver√° con > 1,000 posts');
    } else if (postCount < 1000) {
      console.log('‚úÖ Colecci√≥n mediana (100-1,000 posts)');
      console.log('   ‚Üí Los √≠ndices empiezan a mostrar beneficios');
      console.log('   ‚Üí Monitore queries lentas con .explain()');
    } else {
      console.log('üî• Colecci√≥n grande (> 1,000 posts)');
      console.log('   ‚Üí Los √≠ndices son CR√çTICOS para performance');
      console.log('   ‚Üí Cada query debe usar un √≠ndice apropiado');
    }

    console.log('\nüìå Verificar que todas las queries usen √≠ndices:');
    console.log('   ‚Üí Eficiencia ideal: > 80% (docs retornados / docs examinados)');
    console.log('   ‚Üí Si ve "COLLECTION SCAN", crear √≠ndice apropiado');
    console.log('   ‚Üí Tiempo de query: < 10ms es excelente, < 50ms es aceptable');

    console.log('\n\n‚úÖ Verificaci√≥n completada\n');

  } catch (error) {
    console.error('‚ùå Error:', error.message);
  } finally {
    await mongoose.disconnect();
    console.log('üîå Desconectado de MongoDB');
  }
}

// Ejecutar script
verifyBlogIndexes();
